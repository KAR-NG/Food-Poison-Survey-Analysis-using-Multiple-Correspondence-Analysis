---
title: "poison_survey"
author: "Kar"
date: '2022-05-05'
output: 
  github_document: 
    toc: true
    toc_depth: 4
always_allow_html: yes
---


## 1 SUMMARY

## 2 R PACKAGES

```{r, message=FALSE, warning=FALSE}

library(tidyverse)
library(skimr)
library(tidytext)
library(cowplot)
library(factoextra)
library(FactoMineR)
library(corrplot)

```


## 3 INTRODUCTION

This project will analyse a survey dataset using one of the principal component methods. The technique of "Principal component methods" is known as one of the machine learning methods, belonging to the "unsupervised" branch, which can quickly summarise a dataset by revealing the most important variables (columns) or observations (rows) in the dataset. 

The data of this survey dataset was collected from students in a primary school who suffered from food poisoning. The dataset contains various type of information such as age, time, whether the student is sicked, sex, symptoms of food poisoning (nausea, vomiting, abdominal, fever, and diarrhea) and food they ate (potato, fish, mayo, courgette, cheese, ice cream).





## 4 DATA PREPARATION

The dataset of this project is called "poison", which is a public dataset from the R package "FactoMineR".

### 4.1 Data Import

Following code download the dataset from the package.

```{r}
data(poison)

```

Randomly sample 10 rows within the dataset:

```{r}
sample_n(poison, 10)

```

### 4.2 Data Exploration

The dataset has 55 rows (55 students) and 15 columns recording the various type of variables (also known as feature).

Following code also shows the variable type allocated by R to each of the column. 

```{r}
glimpse(poison)

```

Factor "fct" is a variable type we usually allocate to variables that have categorisation nature. There is usually a conversion step required to perform by analyst to convert character "chr" variable such as "Yes" and "No" into factor "fct". This step seems like has been completed.

Insights from following summary, 

* Respondents have age between 4 to 88, with majority of them fall between 6 to 10 years old with a median of 8. Mean of 16.93 shouldn't be used for reference because 88 is a outlier.   
* Time should be time of recording the data.   
* The rest of the variables have two categories of either "Yes" or "No".  

```{r}
summary(poison)

```
Following is an alternative to see the structure of the dataset. Other than Age and time, the rest of the variables are factor type with 2 levels, of either "Y" or "No", which stand for "Yes" or "No". 

```{r}
str(poison)

```

Checking missing data in the dataset, there is no missing data deteccted by examining the column "n_missing" and "complete_rate" in following tables. This special summary also summarise that there are 13 factor variables and 2 numerical variables. 

```{r}
skim_without_charts(poison)

```
Alternatively, using following code to check missing data in the dataset.

```{r}
colSums(is.na(poison))

```

There is no missing data in the dataset. 


## 5 EDA

EDA stands for Exploratory data analysis, which is using graphical methods to explore the data, to find and understand trends. 

### 5.1 Age and Time

```{r, message=FALSE}

# df

df5.2 <- poison %>% 
  dplyr::select("Age", "Time") %>% 
  pivot_longer(c(1:2), names_to = "var", values_to = "val") %>% 
  mutate(var = as.factor(var),
         val = as.factor(val)) %>% 
  group_by(var, val) %>% 
  summarise(count = n()) %>% 
  ungroup()
  
df5.2

# graph

ggplot(df5.2, aes(x = val, y = count, fill = var)) +
  geom_bar(stat = "identity", color = "black") +
  geom_text(aes(label = count), vjust = -0.2) +
  facet_wrap(~var, scale = "free") +
  theme_bw() +
  theme(legend.position = "none",
        plot.title = element_text(hjust = 0.5, face = "bold"),
        plot.subtitle = element_text(hjust = 0.5)) +
  labs(title = "The distribution of Age and Time",
       subtitle = "by Histogram",
       x = "Value",
       y = "Head Count")

```
From above graph, I can figure that students participated in the survey were between 5 to 11 years old. The 4 years old child might be a visitor brought by one of the adults between 36 to 88 years old. These adults might be visitors or teachers. The identity of these adults are not important, as well as the variable "Time" because I am more focus on what food cause the food poisoning.  


### 5.2 Dashboard

There are 13 variables left to visualise, I will now create a static dashboard to view all of these variables at once. 

```{r, message=FALSE, fig.height=8, fig.width=9}
# set data frames

info <- poison %>% dplyr::select(Sick, Sex)
symptom <- poison %>% dplyr::select(Sick, Nausea, Vomiting, Abdominals, Fever, Diarrhae) 
food <- poison %>% dplyr::select(c(Sick, 10:15)) 

# graph for info

graph_info <- info %>% 
  pivot_longer(c(1:2), names_to = "var", values_to = "val") %>% 
  mutate(var = as.factor(var),
         val = as.factor(val)) %>% 
  group_by(var, val) %>% 
  summarise(count = n()) %>% 
  ungroup() %>% 
  ggplot(aes(x = val, y = count)) +
  geom_bar(stat = "identity", color = "black", fill = "purple") +
  geom_text(aes(label = count), vjust = 1.5, color = "white") +
  facet_wrap(~var, scale = "free") +
  theme_bw() +
  theme(legend.position = "none",
        plot.title = element_text(hjust = 0.5, face = "bold"),
        plot.subtitle = element_text(hjust = 0.5)) +
  labs(x = "", 
       y = "Head Count",
       title = "Status")


## graph for symptom

graph_symptom <- symptom %>% 
  pivot_longer(c(2:6), names_to = "var", values_to = "val") %>% 
  mutate(var = as.factor(var),
         val = as.factor(val)) %>% 
  group_by(Sick, var, val) %>% 
  summarise(count = n()) %>% 
  ungroup() %>%   
  ggplot(aes(x = val, y = count, fill = Sick)) +
  geom_bar(stat = "identity",
           position = "dodge",
           color = "black") +
  geom_label(aes(label = count), color = "black",
            position = position_dodge(width = 0.9)) +
  facet_wrap(~var, scale = "free_x", nrow = 1) +
  theme_bw() +
  theme(legend.position = "top",
        plot.title = element_text(hjust = 0.5, face = "bold"),
        plot.subtitle = element_text(hjust = 0.5),
        axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.2)) +
  labs(x = "",
       y = "",
       title = "Symptoms")

## graph for food

graph_food <- food %>% 
  pivot_longer(c(2:7), names_to = "var", values_to = "val") %>% 
  mutate(var = as.factor(var),
         val = as.factor(val)) %>% 
  group_by(Sick, var, val) %>% 
  summarise(count = n()) %>% 
  ungroup() %>% 
  ggplot(aes(y = val, x = count, fill = Sick)) +
  geom_bar(stat = "identity", color = "black",
           position = "dodge") +
  geom_label(aes(label = count), hjust = 0.8,
             position = position_dodge(width = 0.9)) +
  facet_wrap(~var, scale = "free_y") +
  theme_bw() +
  theme(legend.position = "right",
        plot.title = element_text(hjust = 0.5, face = "bold"),
        plot.subtitle = element_text(hjust = 0.5)) +
  labs(y = "",
       x = "Head Count",
       title = "Food Ate")

# Dashboard

title <- ggdraw() + draw_label("Food Poisoning Dataset Analysis", fontface = "bold", size = 20)

top_row <- plot_grid(graph_info, graph_symptom,
                     rel_widths = c(1, 2.5))

plot_grid(title, top_row, graph_food, 
          ncol = 1,
          rel_heights = c(0.2, 1.2, 1))

```

**Insights**

* 38 persons out of 55 were sick.  

* Almost all of the responds who suffered from food poisoning experience abdominals, diarrhea, and fever. 20% of them suffered from nausea and 40% suffered from vomiting. 

Almost all sicked persons (green) ate all the food mentioned in the graph. However, there were many healthy persons also ate these food. It can be difficult to estimate which food cause food poisoning. 


## 6 PRINCIPAL COMPONENT METHODS

There are 5 types of principal component (pc) methods:

* Principal Component Analysis (PCA)
* Correspondence Analysis (CA)  
* Multiple Correspondence Analysis (MCA)  
* Factor Analysis of Mixed Data (FAMD)  
* Multiple Factor Analysis (MFA)  

All of these PC methods are designed for different type of datasets. For example, PCA is chosen when all variables of a particular dataset are numeric. 

In the case of the dataset used in this project, MCA is chosen. It is chosen to analyse multiple categorical variables in the dataset. Numerical variables such as "Age" and "Time" will be treated as supplementary variables, as well as the variables "Sick" and "Sex". Supplementary information can be qualitative variables, quantitative variables, or even observation (rows). Supplementary variables will not affect the principal components of the analysis. They are used to help interpreting the variability in the dataset. Since I am more interested in the variable "Sick", I will only use this supplementary variable in the analysis.     

Principal component methods (multiple correspondence analysis in this case) will extract total variation from a datasets and express them as a few new variables, called principal components, without loosing important information. The goal is to overlapping the best principal components with the coordinate of variables and observations, then identify directions on principal components that explained the highest variation is maximal (KASSAMBARA A 2017). 

### 6.1 MCA 

Multiple Correspondence Analysis (MCA)'s code is being performed as follow:

* Quantitative supplementary variable: Age, Time  
* Qualitative supplementary variable: Sick, Sex  
* Remaining variables will be participating into the multiple correspondence analysis  

```{r}
my.mca <- MCA(poison, 
              quanti.sup = 1:2, 
              quali.sup = 3:4, 
              graph = F)

```
### 6.2 MCA's PCs

"Eigenvalue" will tells us the amount of variations retained by each principal components (Dim). 

Extracting the eigenvalue from the MCA model:

```{r}
get_eigenvalue(my.mca)

```
Alternatively, scree plot will help better visualise the amount of variation retained by each principal components. 

```{r}
fviz_screeplot(my.mca, addlabels = T, ylim = c(0, 40))

```
The first two dimensions (principal components) explained 46.4% of the variation and they will be used to find interesting patterns in the data. There is no well-accepted method to determine how many PC are enough but in practice, we tend to look at the first two dimensions.

Generally, a cut-off point is when first few dimensions account for a large proportion of the variability, it is known "elbow" which means a significant bend in scree plot, which indicates an optimal dimensionality. 


### 6.3 Variable Analysis

This section will identify the most relatable important variables in the dataset. 

```{r, fig.width=10, fig.height=10}
# Graph
#1
var_cor <- fviz_mca_var(my.mca,
             repel = T,
             choice = "mca.cor") +
  theme_classic() +
  theme(plot.title = element_text(face = "bold", vjust = 4),
        plot.margin = unit(c(1,1,1,1), "cm")) +
  labs(title = "Correlation between Variable and PCs")
#2
cor_plot <- fviz_mca_var(my.mca,
             repel = T,
             invisible = "quali.sup") +
  labs(title = "Coordinate of Variable Categories") +
  theme_minimal() +
  theme(plot.title = element_text(face = "bold", vjust = 4),
        plot.margin = unit(c(1,1,1,1), "cm"))
#3
cos_plot <- fviz_mca_var(my.mca,
             repel = T, 
             invisible = "quali.sup",
             col.var = "cos2",
             gradient.cols = c("yellow", "orange", "red"),
             alpha = "cos2") +
  labs(title = "Coordinate + COS2") + 
  theme(plot.title = element_text(face = "bold", vjust = 4),
        plot.margin = unit(c(1,1,1,1), "cm"))

#4

contrib_plot <- fviz_mca_var(my.mca,
             repel = T,
             col.var = "contrib",
             alpha = "contrib",
             gradient.cols = c("yellow", "orange", "red"),
             invisible = "quali.sup") +
  labs(title = "Coordinate + Contribution") + 
  theme(plot.title = element_text(face = "bold", vjust = 4),
        plot.margin = unit(c(1,1,1,1), "cm"))



#

title <- ggdraw() + draw_label("Analysis of Variables in <Poison> Dataset", fontface = "bold", size = 20)

up <-  plot_grid(var_cor, cor_plot, 
                 labels = c("1", "2"))

middle <- plot_grid(cos_plot, contrib_plot,
                    rel_widths = c(1, 1),
                    labels = c("3", "4"))


plot_grid(title, up, middle,
          nrow = 3,
          rel_heights = c(0.2, 1, 1)
          )




```

**Insights**

* In graph 1, by putting all variables (active + supplementary variables) on the first two dimensions of the graph, and the result show that regardless of the supplementary variables that have no influence on the construction of the axes,   
  * **Diarrhea, Fever and Abdominals** are the most correlated variables with **Dim1**  
  * **Courgette and Potato** are the most correlated variables with **Dim2**  
  * "Sick" among the supplementary variables (blue colored) will be used for analysis in the next section  

* In graph 2, coordinates of each level (categories) of each variable are plotted. Levels with similar profile are grouped together as we can see the "y" and "n" levels are grouped together separately. The distance between each category point with the plot origin indicate the quality of the point on the factor map (graph 2).

* In graph 3, cosine squared (cos2) will help us to visualise which variables are better represented by the first two dimensions. I can tell that Fever_y, Fever_n, Abdo_y, Abdo_n, diarrhea_y, and diarrhea_n are the top 6 best represented variables on the factor map. The list followed by orange colored variables. This results is 

* In graph 4, contribution (contrib) is a measurement converted from cos2 to tell which variable contribute the most to the components. Variables that contribute the most are the most important variables in explaining the variabilities in the dataset. 



### 6.4 Individual Analysis

The term "individual" means the "row" of the dataset, or also known as "observation". "Individual", or more commonly "observation" are the term usually referred to the rows of a structured dataset which has variables as columns and records as rows. 






### Biplot



```{r}
fviz_mca_biplot(my.mca,
                
                # Managing individuals
                col.ind = poison$Sick,
                label = "var",
                legend.title = "Health Status",
                addEllipses = T,
                mean.point = F,

                # Managing variables
                col.var = "black", 
                # Global
                repel = T,
                pointsize = 2.5,
                ) +
  theme_classic() +
  theme(legend.position = "top")


```




## Disclaimer




## REFERENCE

KASSAMBARA A 2017, *Practical Guide To Principal Component Methods in R*, Edition 1, sthda.com